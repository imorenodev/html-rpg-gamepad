var B=Object.defineProperty;var z=(r,t,e)=>t in r?B(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var T=(r,t,e)=>(z(r,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const E="LEFT",x="RIGHT",L="UP",S="DOWN";class q{constructor(){this.heldDirections=[],this.keys={},this.lastKeys={},this.virtualGamepad=null,this.setupKeyboardInput(),this.setupVirtualGamepad()}setupKeyboardInput(){document.addEventListener("keydown",t=>{this.keys[t.code]=!0,this.handleDirectionInput(t.code,!0)}),document.addEventListener("keyup",t=>{this.keys[t.code]=!1,this.handleDirectionInput(t.code,!1)})}setupVirtualGamepad(){if(this.virtualGamepad=document.getElementById("virtual-gamepad"),!this.virtualGamepad)return;this.virtualGamepad.querySelectorAll(".dpad-button[data-direction]").forEach(s=>{const i=s.dataset.direction;s.addEventListener("touchstart",n=>{n.preventDefault(),this.onVirtualDirectionPressed(i),s.classList.add("pressed")}),s.addEventListener("touchend",n=>{n.preventDefault(),this.onVirtualDirectionReleased(i),s.classList.remove("pressed")}),s.addEventListener("mousedown",n=>{n.preventDefault(),this.onVirtualDirectionPressed(i),s.classList.add("pressed")}),s.addEventListener("mouseup",n=>{n.preventDefault(),this.onVirtualDirectionReleased(i),s.classList.remove("pressed")}),s.addEventListener("mouseleave",n=>{this.onVirtualDirectionReleased(i),s.classList.remove("pressed")})}),this.virtualGamepad.querySelectorAll(".action-button[data-key]").forEach(s=>{const i=s.dataset.key;s.addEventListener("touchstart",n=>{n.preventDefault(),this.keys[i]=!0,s.classList.add("pressed")}),s.addEventListener("touchend",n=>{n.preventDefault(),this.keys[i]=!1,s.classList.remove("pressed")}),s.addEventListener("mousedown",n=>{n.preventDefault(),this.keys[i]=!0,s.classList.add("pressed")}),s.addEventListener("mouseup",n=>{n.preventDefault(),this.keys[i]=!1,s.classList.remove("pressed")}),s.addEventListener("mouseleave",n=>{this.keys[i]=!1,s.classList.remove("pressed")})})}handleDirectionInput(t,e){const i={ArrowUp:L,KeyW:L,ArrowDown:S,KeyS:S,ArrowLeft:E,KeyA:E,ArrowRight:x,KeyD:x}[t];i&&(e?this.onArrowPressed(i):this.onArrowReleased(i))}onVirtualDirectionPressed(t){this.onArrowPressed(t)}onVirtualDirectionReleased(t){this.onArrowReleased(t)}get direction(){return this.heldDirections[0]}update(){this.lastKeys={...this.keys}}getActionJustPressed(t){return this.keys[t]&&!this.lastKeys[t]}onArrowPressed(t){this.heldDirections.indexOf(t)===-1&&this.heldDirections.unshift(t)}onArrowReleased(t){const e=this.heldDirections.indexOf(t);e!==-1&&this.heldDirections.splice(e,1)}}class a{constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new a(this.x,this.y)}matches(t){return this.x===t.x&&this.y===t.y}toNeighbor(t){let e=this.x,s=this.y;return t===E&&(e-=16),t===x&&(e+=16),t===L&&(s-=16),t===S&&(s+=16),new a(e,s)}}class V{constructor(t,e){T(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}}class Y{constructor(){T(this,"callbacks",[]);T(this,"nextId",0)}emit(t,e){this.callbacks.forEach(s=>{s.eventName===t&&s.callback(e)})}on(t,e,s){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:s}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const h=new Y;class f{constructor({position:t}){this.position=t??new a(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(t,e){this.children.forEach(s=>s.stepEntry(t,e)),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(t,e)}ready(){}step(t){}draw(t,e,s){const i=e+this.position.x,n=s+this.position.y;this.drawImage(t,i,n),this.getDrawChildrenOrdered().forEach(o=>o.draw(t,i,n))}getDrawChildrenOrdered(){return[...this.children].sort((t,e)=>e.drawLayer==="FLOOR"||t.position.y>e.position.y?1:-1)}drawImage(t,e,s){}destroy(){this.children.forEach(t=>{t.destroy()}),this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){h.unsubscribe(t),this.children=this.children.filter(e=>t!==e)}}class j extends f{constructor(){super({}),h.on("HERO_POSITION",this,t=>{this.centerPositionOnTarget(t)}),h.on("CHANGE_LEVEL",this,t=>{this.centerPositionOnTarget(t.heroStartPosition)})}centerPositionOnTarget(t){this.position=new a(-t.x+152,-t.y+82)}}class p extends f{constructor({resource:t,frameSize:e,hFrames:s,vFrames:i,frame:n,scale:o,position:l,animations:u}){super({name}),this.resource=t,this.frameSize=e??new a(16,16),this.hFrames=s??1,this.vFrames=i??1,this.frame=n??0,this.frameMap=new Map,this.scale=o??1,this.position=l??new a(0,0),this.animations=u??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(t,new a(this.frameSize.x*s,this.frameSize.y*e)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,s){if(!this.resource.isLoaded)return;let i=0,n=0;const o=this.frameMap.get(this.frame);o&&(i=o.x,n=o.y);const l=this.frameSize.x,u=this.frameSize.y;t.drawImage(this.resource.image,i,n,l,u,e,s,l*this.scale,u*this.scale)}}const J="/html-rpg-gamepad/sprites/hero-sheet.png",Q="/html-rpg-gamepad/sprites/shadow.png",$="/html-rpg-gamepad/sprites/rod.png",Z="/html-rpg-gamepad/sprites/exit.png",tt="/html-rpg-gamepad/sprites/sky.png",et="/html-rpg-gamepad/sprites/ground.png",st="/html-rpg-gamepad/sprites/cave-long.png",it="/html-rpg-gamepad/sprites/cave-ground.png",nt="/html-rpg-gamepad/sprites/knight-sheet-1.png",rt="/html-rpg-gamepad/sprites/text-box.png",at="/html-rpg-gamepad/sprites/sprite-font-white.png",ot="/html-rpg-gamepad/sprites/portraits-sheet.png";class ht{constructor(){this.toLoad={hero:J,shadow:Q,rod:$,exit:Z,sky:tt,ground:et,cave:st,caveGround:it,knight:nt,textBox:rt,fontWhite:at,portraits:ot},this.images={},Object.keys(this.toLoad).forEach(t=>{const e=new Image;e.src=this.toLoad[t],this.images[t]={image:e,isLoaded:!1},e.onload=()=>{this.images[t].isLoaded=!0}})}}const m=new ht;class dt extends f{constructor(){super({position:new a(0,1)}),this.drawLayer="HUD",this.nextId=0,this.items=[{id:-1,image:m.images.rod},{id:-2,image:m.images.rod}],h.on("HERO_PICKS_UP_ITEM",this,t=>{this.nextId+=1,this.items.push({id:this.nextId,image:m.images.rod}),this.renderInventory()}),this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{const s=new p({resource:t.image,position:new a(e*12,0)});this.addChild(s)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}}const ct=5,d=new Map;d.set("c",4);d.set("f",4);d.set("i",2);d.set("j",4);d.set("l",3);d.set("n",4);d.set("r",4);d.set("t",4);d.set("u",4);d.set("v",4);d.set("x",4);d.set("y",4);d.set("z",4);d.set("E",4);d.set("F",4);d.set("M",7);d.set("W",7);d.set(" ",3);d.set("'",1);d.set("!",1);const lt=r=>d.get(r)??ct,A=new Map;["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("").forEach((r,t)=>{A.set(r,t)});const mt=r=>A.get(r)??0;class pt extends f{constructor(t={}){super({position:new a(32,108)}),this.drawLayer="HUD";const e=t.string??"Default text";this.words=e.split(" ").map(s=>{let i=0;const n=s.split("").map(o=>{const l=lt(o);return i+=l,{width:l,sprite:new p({resource:m.images.fontWhite,hFrames:13,vFrames:6,frame:mt(o)})}});return{wordWidth:i,chars:n}}),this.backdrop=new p({resource:m.images.textBox,frameSize:new a(256,64)}),this.portrait=new p({resource:m.images.portraits,hFrames:4,frame:t.portraitFrame??0}),this.showingIndex=0,this.finalIndex=this.words.reduce((s,i)=>s+i.chars.length,0),this.textSpeed=80,this.timeUntilNextShow=this.textSpeed}step(t,e){const s=e.input;if(s!=null&&s.getActionJustPressed("Space")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}h.emit("END_TEXT_BOX")}this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&(this.showingIndex+=1,this.timeUntilNextShow=this.textSpeed)}drawImage(t,e,s){this.backdrop.drawImage(t,e,s),this.portrait.drawImage(t,e+6,s+6);const i=27,n=9,o=240,l=14;let u=e+i,v=s+n,O=0;this.words.forEach(_=>{e+o-u<_.wordWidth&&(u=e+i,v+=l),_.chars.forEach(K=>{if(O>this.showingIndex)return;const{sprite:M,width:G}=K,X=u-5;M.draw(t,X,v),u+=G,u+=1,O+=1}),u+=3})}}class ut{constructor(){this.flags=new Map}add(t){this.flags.set(t,!0)}getRelevantScenario(t=[]){return t.find(e=>{const s=e.bypass??[];for(let n=0;n<s.length;n++){const o=s[n];if(this.flags.has(o))return!1}const i=e.requires??[];for(let n=0;n<i.length;n++){const o=i[n];if(!this.flags.has(o))return!1}return!0})}}const P="TALKED_TO_A",F="TALKED_TO_B",R=new ut;class ft extends f{constructor(){super({}),this.level=null,this.input=new q,this.camera=new j}ready(){const t=new dt;this.addChild(t),h.on("CHANGE_LEVEL",this,e=>{this.setLevel(e)}),h.on("HERO_REQUESTS_ACTION",this,e=>{if(typeof e.getContent=="function"){const s=e.getContent();if(!s)return;console.log(s),s.addsFlag&&(console.log("ADD FLAG",s.addsFlag),R.add(s.addsFlag));const i=new pt({portraitFrame:s.portraitFrame,string:s.string});this.addChild(i),h.emit("START_TEXT_BOX");const n=h.on("END_TEXT_BOX",this,()=>{i.destroy(),h.off(n)})}})}setLevel(t){this.level&&this.level.destroy(),this.level=t,this.addChild(this.level)}drawBackground(t){var e;(e=this.level)==null||e.background.drawImage(t,0,0)}drawObjects(t){this.children.forEach(e=>{e.drawLayer!=="HUD"&&e.draw(t,0,0)})}drawForeground(t){this.children.forEach(e=>{e.drawLayer==="HUD"&&e.draw(t,0,0)})}}class H extends f{constructor(){super({}),this.background=null}}const c=r=>r*16,gt=(r,t,e)=>{const s=`${t},${e}`;return!r.has(s)};class N extends f{constructor(t,e){super({position:new a(t,e)}),this.addChild(new p({resource:m.images.exit})),this.drawLayer="FLOOR"}ready(){h.on("HERO_POSITION",this,t=>{const e=Math.round(t.x),s=Math.round(t.y);e===this.position.x&&s===this.position.y&&h.emit("HERO_EXITS")})}}class wt{constructor(t){this.patterns=t,this.activeKey=Object.keys(this.patterns)[0]}get frame(){return this.patterns[this.activeKey].frame}play(t,e=0){this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=e)}step(t){this.patterns[this.activeKey].step(t)}}class w{constructor(t){this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}get frame(){const{frames:t}=this.animationConfig;for(let e=t.length-1;e>=0;e--)if(this.currentTime>=t[e].time)return t[e].frame;throw"Time is before the first keyframe"}step(t){this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)}}const I=(r=0)=>({duration:400,frames:[{time:0,frame:r}]}),D=(r=0)=>({duration:400,frames:[{time:0,frame:r+1},{time:100,frame:r},{time:200,frame:r+1},{time:300,frame:r+2}]}),yt=I(1),vt=I(4),St=I(7),Et=I(10),xt=D(0),Lt=D(3),Tt=D(6),It=D(9),Dt={duration:400,frames:[{time:0,frame:12}]};function Pt(r,t,e){let s=t.x-r.position.x,i=t.y-r.position.y,n=Math.sqrt(s**2+i**2);if(n<=e)r.position.x=t.x,r.position.y=t.y;else{let o=s/n,l=i/n;r.position.x+=o*e,r.position.y+=l*e,s=t.x-r.position.x,i=t.y-r.position.y,n=Math.sqrt(s**2+i**2)}return n}class b extends f{constructor(t,e){super({position:new a(t,e)});const s=new p({resource:m.images.shadow,frameSize:new a(32,32),position:new a(-8,-19)});this.addChild(s),this.body=new p({resource:m.images.hero,frameSize:new a(32,32),hFrames:3,vFrames:8,frame:1,position:new a(-8,-20),animations:new wt({walkDown:new w(xt),walkUp:new w(Tt),walkLeft:new w(It),walkRight:new w(Lt),standDown:new w(yt),standUp:new w(St),standLeft:new w(Et),standRight:new w(vt),pickUpDown:new w(Dt)})}),this.addChild(this.body),this.facingDirection=S,this.destinationPosition=this.position.duplicate(),this.itemPickupTime=0,this.itemPickupShell=null,this.isLocked=!1,h.on("HERO_PICKS_UP_ITEM",this,i=>{this.onPickUpItem(i)})}ready(){h.on("START_TEXT_BOX",this,()=>{this.isLocked=!0}),h.on("END_TEXT_BOX",this,()=>{this.isLocked=!1})}step(t,e){if(this.isLocked)return;if(this.itemPickupTime>0){this.workOnItemPickup(t);return}const s=e.input;if(s!=null&&s.getActionJustPressed("Space")){const o=this.parent.children.find(l=>l.position.matches(this.position.toNeighbor(this.facingDirection)));o&&h.emit("HERO_REQUESTS_ACTION",o)}Pt(this,this.destinationPosition,1)<=1&&this.tryMove(e),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,h.emit("HERO_POSITION",this.position))}tryMove(t){var u;const{input:e}=t;if(!e.direction){this.facingDirection===E&&this.body.animations.play("standLeft"),this.facingDirection===x&&this.body.animations.play("standRight"),this.facingDirection===L&&this.body.animations.play("standUp"),this.facingDirection===S&&this.body.animations.play("standDown");return}let s=this.destinationPosition.x,i=this.destinationPosition.y;const n=16;e.direction===S&&(i+=n,this.body.animations.play("walkDown")),e.direction===L&&(i-=n,this.body.animations.play("walkUp")),e.direction===E&&(s-=n,this.body.animations.play("walkLeft")),e.direction===x&&(s+=n,this.body.animations.play("walkRight")),this.facingDirection=e.direction??this.facingDirection;const o=gt((u=t.level)==null?void 0:u.walls,s,i),l=this.parent.children.find(v=>v.isSolid&&v.position.x===s&&v.position.y===i);o&&!l&&(this.destinationPosition.x=s,this.destinationPosition.y=i)}onPickUpItem({image:t,position:e}){this.destinationPosition=e.duplicate(),this.itemPickupTime=500,this.itemPickupShell=new f({}),this.itemPickupShell.addChild(new p({resource:t,position:new a(0,-18)})),this.addChild(this.itemPickupShell)}workOnItemPickup(t){this.itemPickupTime-=t,this.body.animations.play("pickUpDown"),this.itemPickupTime<=0&&this.itemPickupShell.destroy()}}class U extends f{constructor(t,e){super({name:"Rod",position:new a(t,e)});const s=new p({resource:m.images.rod,position:new a(0,-5)});this.addChild(s)}ready(){h.on("HERO_POSITION",this,t=>{const e=Math.round(t.x),s=Math.round(t.y);e===this.position.x&&s===this.position.y&&this.onCollideWithHero()})}onCollideWithHero(){this.destroy(),h.emit("HERO_PICKS_UP_ITEM",{type:"ROD",image:m.images.rod,position:this.position})}}const kt=new a(c(6),c(5));class Ot extends H{constructor(t={}){super({}),this.background=new p({resource:m.images.sky,frameSize:new a(320,180)});const e=new p({resource:m.images.ground,frameSize:new a(320,180)});this.addChild(e);const s=new N(c(6),c(3));this.addChild(s),this.heroStartPosition=t.heroPosition??kt;const i=new b(this.heroStartPosition.x,this.heroStartPosition.y);this.addChild(i);const n=new U(c(7),c(6));this.addChild(n),this.walls=new Set,this.walls.add("64,48"),this.walls.add("64,64"),this.walls.add("64,80"),this.walls.add("80,64"),this.walls.add("80,80"),this.walls.add("112,80"),this.walls.add("128,80"),this.walls.add("144,80"),this.walls.add("160,80")}ready(){h.on("HERO_EXITS",this,()=>{h.emit("CHANGE_LEVEL",new W({heroPosition:new a(c(3),c(6))}))})}}class C extends f{constructor(t,e,s={}){super({position:new a(t,e)}),this.isSolid=!0,this.textContent=s.content,this.textPortraitFrame=s.portraitFrame;const i=new p({resource:m.images.shadow,frameSize:new a(32,32),position:new a(-8,-19)});this.addChild(i);const n=new p({resource:m.images.knight,frameSize:new a(32,32),hFrames:2,vFrames:1,position:new a(-8,-20)});this.addChild(n)}getContent(){const t=R.getRelevantScenario(this.textContent);return t?{portraitFrame:this.textPortraitFrame,string:t.string,addsFlag:t.addsFlag??null}:(console.warn("No matches found in this list!",this.textContent),null)}}const _t=new a(c(6),c(5));class W extends H{constructor(t={}){super({}),this.background=new p({resource:m.images.cave,frameSize:new a(320,360)});const e=new p({resource:m.images.caveGround,frameSize:new a(320,180)});this.addChild(e);const s=new N(c(3),c(5));this.addChild(s),this.heroStartPosition=t.heroPosition??_t;const i=new b(this.heroStartPosition.x,this.heroStartPosition.y);this.addChild(i);const n=new U(c(9),c(6));this.addChild(n);const o=new C(c(5),c(5),{content:[{string:"I just can't stand that guy.",requires:[F],bypass:[P],addsFlag:P},{string:"He is just the worst!",requires:[P]},{string:"Grumble grumble. Another day at work.",requires:[]}],portraitFrame:1});this.addChild(o);const l=new C(c(8),c(5),{content:[{string:"What a wonderful day at work in the cave!",requires:[],addsFlag:F}],portraitFrame:0});this.addChild(l),this.walls=new Set}ready(){h.on("HERO_EXITS",this,()=>{h.emit("CHANGE_LEVEL",new Ot({heroPosition:new a(c(16),c(4))}))})}}const k=document.querySelector("#game-canvas"),y=k.getContext("2d"),g=new ft({position:new a(0,0)});g.setLevel(new W);const Ft=r=>{var t;g.stepEntry(r,g),(t=g.input)==null||t.update()},Ct=()=>{y.clearRect(0,0,k.width,k.height),g.drawBackground(y),y.save(),g.camera&&y.translate(g.camera.position.x,g.camera.position.y),g.drawObjects(y),y.restore(),g.drawForeground(y)},At=new V(Ft,Ct);At.start();
