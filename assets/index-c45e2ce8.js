var J=Object.defineProperty;var Y=(a,e,t)=>e in a?J(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var L=(a,e,t)=>(Y(a,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const x="LEFT",A="RIGHT",O="UP",S="DOWN";class Q{constructor(){this.heldDirections=[],this.keys={},this.lastKeys={},this.virtualGamepad=null,this.setupKeyboardInput(),this.setupVirtualGamepad()}setupKeyboardInput(){document.addEventListener("keydown",e=>{this.keys[e.code]=!0,this.handleDirectionInput(e.code,!0)}),document.addEventListener("keyup",e=>{this.keys[e.code]=!1,this.handleDirectionInput(e.code,!1)})}setupVirtualGamepad(){if(this.virtualGamepad=document.getElementById("virtual-gamepad"),!this.virtualGamepad)return;this.virtualGamepad.querySelectorAll(".dpad-button[data-direction]").forEach(s=>{const i=s.dataset.direction;s.addEventListener("touchstart",r=>{r.preventDefault(),this.onVirtualDirectionPressed(i),s.classList.add("pressed")}),s.addEventListener("touchend",r=>{r.preventDefault(),this.onVirtualDirectionReleased(i),s.classList.remove("pressed")}),s.addEventListener("mousedown",r=>{r.preventDefault(),this.onVirtualDirectionPressed(i),s.classList.add("pressed")}),s.addEventListener("mouseup",r=>{r.preventDefault(),this.onVirtualDirectionReleased(i),s.classList.remove("pressed")}),s.addEventListener("mouseleave",r=>{this.onVirtualDirectionReleased(i),s.classList.remove("pressed")})}),this.virtualGamepad.querySelectorAll(".action-button[data-key]").forEach(s=>{const i=s.dataset.key;s.addEventListener("touchstart",r=>{r.preventDefault(),this.keys[i]=!0,s.classList.add("pressed")}),s.addEventListener("touchend",r=>{r.preventDefault(),this.keys[i]=!1,s.classList.remove("pressed")}),s.addEventListener("mousedown",r=>{r.preventDefault(),this.keys[i]=!0,s.classList.add("pressed")}),s.addEventListener("mouseup",r=>{r.preventDefault(),this.keys[i]=!1,s.classList.remove("pressed")}),s.addEventListener("mouseleave",r=>{this.keys[i]=!1,s.classList.remove("pressed")})})}handleDirectionInput(e,t){const i={ArrowUp:O,KeyW:O,ArrowDown:S,KeyS:S,ArrowLeft:x,KeyA:x,ArrowRight:A,KeyD:A}[e];i&&(t?this.onArrowPressed(i):this.onArrowReleased(i))}onVirtualDirectionPressed(e){this.onArrowPressed(e)}onVirtualDirectionReleased(e){this.onArrowReleased(e)}get direction(){return this.heldDirections[0]}update(){this.lastKeys={...this.keys}}getActionJustPressed(e){return this.keys[e]&&!this.lastKeys[e]}onArrowPressed(e){this.heldDirections.indexOf(e)===-1&&this.heldDirections.unshift(e)}onArrowReleased(e){const t=this.heldDirections.indexOf(e);t!==-1&&this.heldDirections.splice(t,1)}}class o{constructor(e=0,t=0){this.x=e,this.y=t}duplicate(){return new o(this.x,this.y)}matches(e){return this.x===e.x&&this.y===e.y}toNeighbor(e){let t=this.x,s=this.y;return e===x&&(t-=16),e===A&&(t+=16),e===O&&(s-=16),e===S&&(s+=16),new o(t,s)}}class j{constructor(e,t){L(this,"mainLoop",e=>{if(!this.isRunning)return;let t=e-this.lastFrameTime;for(this.lastFrameTime=e,this.accumulatedTime+=t;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=e,this.render=t,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}}class Z{constructor(){L(this,"callbacks",[]);L(this,"nextId",0)}emit(e,t){this.callbacks.forEach(s=>{s.eventName===e&&s.callback(t)})}on(e,t,s){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:e,caller:t,callback:s}),this.nextId}off(e){this.callbacks=this.callbacks.filter(t=>t.id!==e)}unsubscribe(e){this.callbacks=this.callbacks.filter(t=>t.caller!==e)}}const h=new Z;class w{constructor({position:e}){this.position=e??new o(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(e,t){this.children.forEach(s=>s.stepEntry(e,t)),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(e,t)}ready(){}step(e){}draw(e,t,s){const i=t+this.position.x,r=s+this.position.y;this.drawImage(e,i,r),this.getDrawChildrenOrdered().forEach(n=>n.draw(e,i,r))}getDrawChildrenOrdered(){return[...this.children].sort((e,t)=>t.drawLayer==="FLOOR"||e.position.y>t.position.y?1:-1)}drawImage(e,t,s){}destroy(){this.children.forEach(e=>{e.destroy()}),this.parent.removeChild(this)}addChild(e){e.parent=this,this.children.push(e)}removeChild(e){h.unsubscribe(e),this.children=this.children.filter(t=>e!==t)}}class ee extends w{constructor(){super({}),h.on("HERO_POSITION",this,e=>{this.centerPositionOnTarget(e)}),h.on("CHANGE_LEVEL",this,e=>{this.centerPositionOnTarget(e.heroStartPosition)})}centerPositionOnTarget(e){this.position=new o(-e.x+152,-e.y+82)}}class y extends w{constructor({resource:e,frameSize:t,hFrames:s,vFrames:i,frame:r,scale:n,position:l,animations:c}){super({name}),this.resource=e,this.frameSize=t??new o(16,16),this.hFrames=s??1,this.vFrames=i??1,this.frame=r??0,this.frameMap=new Map,this.scale=n??1,this.position=l??new o(0,0),this.animations=c??null,this.buildFrameMap()}buildFrameMap(){let e=0;for(let t=0;t<this.vFrames;t++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(e,new o(this.frameSize.x*s,this.frameSize.y*t)),e++}step(e){this.animations&&(this.animations.step(e),this.frame=this.animations.frame)}drawImage(e,t,s){if(!this.resource.isLoaded)return;let i=0,r=0;const n=this.frameMap.get(this.frame);n&&(i=n.x,r=n.y);const l=this.frameSize.x,c=this.frameSize.y;e.drawImage(this.resource.image,i,r,l,c,t,s,l*this.scale,c*this.scale)}}const te="/html-rpg-gamepad/sprites/hero-sheet.png",se="/html-rpg-gamepad/sprites/shadow.png",ie="/html-rpg-gamepad/sprites/rod.png",re="/html-rpg-gamepad/sprites/exit.png",ae="/html-rpg-gamepad/sprites/sky.png",ne="/html-rpg-gamepad/sprites/ground.png",oe="/html-rpg-gamepad/sprites/cave-long.png",he="/html-rpg-gamepad/sprites/cave-ground.png",le="/html-rpg-gamepad/sprites/knight-sheet-1.png",ce="/html-rpg-gamepad/sprites/text-box.png",de="/html-rpg-gamepad/sprites/sprite-font-white.png",ue="/html-rpg-gamepad/sprites/portraits-sheet.png";class pe{constructor(){this.toLoad={hero:te,shadow:se,rod:ie,exit:re,sky:ae,ground:ne,cave:oe,caveGround:he,knight:le,textBox:ce,fontWhite:de,portraits:ue},this.images={},Object.keys(this.toLoad).forEach(e=>{const t=new Image;t.src=this.toLoad[e],this.images[e]={image:t,isLoaded:!1},t.onload=()=>{this.images[e].isLoaded=!0}})}}const m=new pe;class me extends w{constructor(){super({position:new o(0,1)}),this.drawLayer="HUD",this.nextId=0,this.items=[{id:-1,image:m.images.rod},{id:-2,image:m.images.rod}],h.on("HERO_PICKS_UP_ITEM",this,e=>{this.nextId+=1,this.items.push({id:this.nextId,image:m.images.rod}),this.renderInventory()}),this.renderInventory()}renderInventory(){this.children.forEach(e=>e.destroy()),this.items.forEach((e,t)=>{const s=new y({resource:e.image,position:new o(t*12,0)});this.addChild(s)})}removeFromInventory(e){this.items=this.items.filter(t=>t.id!==e),this.renderInventory()}}const fe=5,p=new Map;p.set("c",4);p.set("f",4);p.set("i",2);p.set("j",4);p.set("l",3);p.set("n",4);p.set("r",4);p.set("t",4);p.set("u",4);p.set("v",4);p.set("x",4);p.set("y",4);p.set("z",4);p.set("E",4);p.set("F",4);p.set("M",7);p.set("W",7);p.set(" ",3);p.set("'",1);p.set("!",1);const ye=a=>p.get(a)??fe,U=new Map;["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("").forEach((a,e)=>{U.set(a,e)});const we=a=>U.get(a)??0;class W extends w{constructor(e={}){super({position:new o(32,108)}),this.drawLayer="HUD";const t=e.string??"Default text";this.words=t.split(" ").map(s=>{let i=0;const r=s.split("").map(n=>{const l=ye(n);return i+=l,{width:l,sprite:new y({resource:m.images.fontWhite,hFrames:13,vFrames:6,frame:we(n)})}});return{wordWidth:i,chars:r}}),this.backdrop=new y({resource:m.images.textBox,frameSize:new o(256,64)}),this.portrait=new y({resource:m.images.portraits,hFrames:4,frame:e.portraitFrame??0}),this.showingIndex=0,this.finalIndex=this.words.reduce((s,i)=>s+i.chars.length,0),this.textSpeed=80,this.timeUntilNextShow=this.textSpeed}step(e,t){const s=t.input;if(s!=null&&s.getActionJustPressed("Space")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}h.emit("END_TEXT_BOX")}this.timeUntilNextShow-=e,this.timeUntilNextShow<=0&&(this.showingIndex+=1,this.timeUntilNextShow=this.textSpeed)}drawImage(e,t,s){this.backdrop.drawImage(e,t,s),this.portrait.drawImage(e,t+6,s+6);const i=27,r=9,n=240,l=14;let c=t+i,d=s+r,g=0;this.words.forEach(f=>{t+n-c<f.wordWidth&&(c=t+i,d+=l),f.chars.forEach(M=>{if(g>this.showingIndex)return;const{sprite:k,width:D}=M,q=c-5;k.draw(e,q,d),c+=D,c+=1,g+=1}),c+=3})}}class ge{constructor(){this.flags=new Map}add(e){this.flags.set(e,!0)}getRelevantScenario(e=[]){return e.find(t=>{const s=t.bypass??[];for(let r=0;r<s.length;r++){const n=s[r];if(this.flags.has(n))return!1}const i=t.requires??[];for(let r=0;r<i.length;r++){const n=i[r];if(!this.flags.has(n))return!1}return!0})}}const _="TALKED_TO_A",Ee="TALKED_TO_B",G=new ge;class Te{constructor(e={}){this.maxHp=e.hp||100,this.hp=this.maxHp,this.attack=e.attack||50,this.defense=e.defense||50,this.speed=e.speed||50,this.level=e.level||5}takeDamage(e){return this.hp=Math.max(0,this.hp-e),this.hp<=0}heal(e){this.hp=Math.min(this.maxHp,this.hp+e)}getHpPercentage(){return this.hp/this.maxHp*100}}class ve{constructor(e){this.name=e.name||"Unknown",this.stats=new Te(e.stats),this.moves=e.moves||[],this.sprite=e.sprite||null,this.isWild=e.isWild||!1,this.statusEffect=null,this.statModifiers={attack:0,defense:0,speed:0}}getAvailableMoves(){return this.moves.filter(e=>e.canUse())}useMove(e,t){const s=this.moves[e];if(!s||!s.canUse())return{success:!1,message:`${this.name} can't use that move!`};if(s.use(),!s.hitCheck())return{success:!0,hit:!1,message:`${this.name} used ${s.name}, but it missed!`};const i=s.calculateDamage(this,t),r=t.stats.takeDamage(i);let n=`${this.name} used ${s.name}!`;if(i>0&&(n+=` It dealt ${i} damage!`),r&&(n+=` ${t.name} was knocked out!`),s.effect&&typeof s.effect=="function"){const l=s.effect(this,t);l&&l.message&&(n+=` ${l.message}`)}return{success:!0,hit:!0,damage:i,wasKnockedOut:r,message:n}}isAlive(){return this.stats.hp>0}getEffectiveSpeed(){const e=this.statModifiers.speed,t=e>=0?(2+e)/2:2/(2+Math.abs(e));return this.stats.speed*t}}class Ie extends w{constructor(e,t){super({}),this.playerCreature=e,this.enemyCreature=t,this.selectedIndex=0,this.currentMenu=null,this.drawLayer="HUD",this.setupHealthBars(),this.setupCreatureSprites()}setupHealthBars(){this.playerHealthBar={position:new o(160,120),width:120,height:8},this.enemyHealthBar={position:new o(40,20),width:120,height:8}}setupCreatureSprites(){this.playerSpritePos=new o(60,100),this.enemySpritePos=new o(220,40)}showActionMenu(){this.currentMenu="ACTION",this.selectedIndex=0,this.actionOptions=["FIGHT","BAG","POKEMON","RUN"]}showMoveMenu(e){this.currentMenu="MOVE",this.selectedIndex=0,this.moveOptions=e}hideMenus(){this.currentMenu=null}handleInput(e){if(!this.currentMenu||!e)return;const t=this.currentMenu==="ACTION"?this.actionOptions.length-1:this.moveOptions.length-1;(e.getActionJustPressed("ArrowUp")||e.getActionJustPressed("KeyW"))&&(this.selectedIndex=Math.max(0,this.selectedIndex-1)),(e.getActionJustPressed("ArrowDown")||e.getActionJustPressed("KeyS"))&&(this.selectedIndex=Math.min(t,this.selectedIndex+1)),(e.getActionJustPressed("ArrowLeft")||e.getActionJustPressed("KeyA"))&&this.currentMenu==="ACTION"&&(this.selectedIndex=this.selectedIndex<2?this.selectedIndex:this.selectedIndex-2),(e.getActionJustPressed("ArrowRight")||e.getActionJustPressed("KeyD"))&&this.currentMenu==="ACTION"&&(this.selectedIndex=this.selectedIndex<2?this.selectedIndex+2:this.selectedIndex,this.selectedIndex=Math.min(t,this.selectedIndex)),(e.getActionJustPressed("Space")||e.getActionJustPressed("Enter"))&&(this.currentMenu==="ACTION"?h.emit("BATTLE_ACTION_SELECTED",this.actionOptions[this.selectedIndex]):this.currentMenu==="MOVE"&&h.emit("BATTLE_MOVE_SELECTED",this.selectedIndex)),e.getActionJustPressed("Escape")&&this.currentMenu==="MOVE"&&this.showActionMenu()}updateHealthBars(){}drawImage(e,t,s){this.drawCreatureInfo(e,t,s),this.drawHealthBars(e,t,s),this.currentMenu==="ACTION"?this.drawActionMenu(e,t,s):this.currentMenu==="MOVE"&&this.drawMoveMenu(e,t,s)}drawCreatureInfo(e,t,s){e.fillStyle="#fff",e.font="8px Arial",e.fillText(`${this.enemyCreature.name} Lv.${this.enemyCreature.stats.level}`,t+this.enemyHealthBar.position.x,s+this.enemyHealthBar.position.y-12),e.fillText(`${this.playerCreature.name} Lv.${this.playerCreature.stats.level}`,t+this.playerHealthBar.position.x,s+this.playerHealthBar.position.y-12),e.fillText(`${this.playerCreature.stats.hp}/${this.playerCreature.stats.maxHp}`,t+this.playerHealthBar.position.x+this.playerHealthBar.width-40,s+this.playerHealthBar.position.y+12)}drawHealthBars(e,t,s){this.drawHealthBar(e,t+this.playerHealthBar.position.x,s+this.playerHealthBar.position.y,this.playerHealthBar.width,this.playerHealthBar.height,this.playerCreature.stats.getHpPercentage()),this.drawHealthBar(e,t+this.enemyHealthBar.position.x,s+this.enemyHealthBar.position.y,this.enemyHealthBar.width,this.enemyHealthBar.height,this.enemyCreature.stats.getHpPercentage())}drawHealthBar(e,t,s,i,r,n){e.fillStyle="#333",e.fillRect(t,s,i,r);let l="#4CAF50";n<50&&(l="#FF9800"),n<20&&(l="#F44336"),e.fillStyle=l;const c=i*n/100;e.fillRect(t,s,c,r),e.strokeStyle="#000",e.lineWidth=1,e.strokeRect(t,s,i,r)}drawActionMenu(e,t,s){const i=t+160,r=s+140,n=150,l=60;e.fillStyle="#222",e.fillRect(i,r,n,l),e.strokeStyle="#fff",e.lineWidth=2,e.strokeRect(i,r,n,l),e.fillStyle="#fff",e.font="12px Arial";const c=this.actionOptions;for(let d=0;d<c.length;d++){const g=i+10+d%2*70,f=r+20+Math.floor(d/2)*20;d===this.selectedIndex&&(e.fillStyle="#ffff00",e.fillText("►",g-15,f)),e.fillStyle=d===this.selectedIndex?"#ffff00":"#fff",e.fillText(c[d],g,f)}}drawMoveMenu(e,t,s){const i=t+20,r=s+140,n=280,l=80;e.fillStyle="#222",e.fillRect(i,r,n,l),e.strokeStyle="#fff",e.lineWidth=2,e.strokeRect(i,r,n,l),e.font="10px Arial";const c=this.moveOptions;for(let d=0;d<Math.min(4,c.length);d++){const g=c[d],f=i+10+d%2*130,v=r+20+Math.floor(d/2)*30;d===this.selectedIndex&&(e.fillStyle="#ffff00",e.fillText("►",f-15,v)),e.fillStyle=d===this.selectedIndex?"#ffff00":"#fff",e.fillText(g.name,f,v),e.fillStyle="#ccc",e.fillText(`${g.pp}/${g.maxPp}`,f,v+12)}if(this.selectedIndex<c.length){const d=c[this.selectedIndex];e.fillStyle="#fff",e.font="8px Arial";const g=d.description.split(" ");let f="",v=r+65;for(let M of g){const k=f+M+" ";e.measureText(k).width>n-20&&f!==""?(e.fillText(f,i+10,v),f=M+" ",v+=10):f=k}e.fillText(f,i+10,v)}}}class Ce extends w{constructor(e,t){super({}),this.playerCreature=e,this.enemyCreature=t,this.currentTurn=null,this.battlePhase="INTRO",this.actionQueue=[],this.isProcessingActions=!1,this.currentTextBox=null,this.battleUI=new Ie(this.playerCreature,this.enemyCreature),this.addChild(this.battleUI),this.turnOrder=[],this.currentTurnIndex=0}ready(){this.showIntroText(),h.on("BATTLE_ACTION_SELECTED",this,e=>{this.handleActionSelection(e)}),h.on("BATTLE_MOVE_SELECTED",this,e=>{this.handleMoveSelection(e)}),h.on("END_TEXT_BOX",this,()=>{this.onTextBoxEnd()})}showIntroText(){const e=`A wild ${this.enemyCreature.name} appeared!`;this.showMessage(e,()=>{this.battlePhase="CHOOSE_ACTION",this.battleUI.showActionMenu()})}showMessage(e,t=null){this.currentTextBox&&this.currentTextBox.destroy(),this.currentTextBox=new W({string:e,portraitFrame:0}),this.addChild(this.currentTextBox),this.onTextBoxEndCallback=t}onTextBoxEnd(){if(this.currentTextBox&&(this.currentTextBox.destroy(),this.currentTextBox=null),this.onTextBoxEndCallback){const e=this.onTextBoxEndCallback;this.onTextBoxEndCallback=null,e()}}handleActionSelection(e){if(this.battlePhase==="CHOOSE_ACTION")switch(e){case"FIGHT":this.battlePhase="CHOOSE_MOVE",this.battleUI.showMoveMenu(this.playerCreature.moves);break;case"RUN":this.attemptRun();break;default:this.showMessage("That action isn't implemented yet!",()=>{this.battlePhase="CHOOSE_ACTION",this.battleUI.showActionMenu()})}}handleMoveSelection(e){if(this.battlePhase!=="CHOOSE_MOVE")return;const t=this.playerCreature.moves[e];if(!t||!t.canUse()){this.showMessage("That move can't be used!",()=>{this.battleUI.showMoveMenu(this.playerCreature.moves)});return}const s=this.chooseEnemyMove();this.determineTurnOrder({creature:this.playerCreature,moveIndex:e,isPlayer:!0},{creature:this.enemyCreature,moveIndex:s,isPlayer:!1}),this.battlePhase="EXECUTING",this.battleUI.hideMenus(),this.executeNextAction()}chooseEnemyMove(){return this.enemyCreature.getAvailableMoves().length===0?0:Math.floor(Math.random()*this.enemyCreature.moves.length)}determineTurnOrder(e,t){this.actionQueue=[];const s=e.creature.getEffectiveSpeed(),i=t.creature.getEffectiveSpeed();s>=i?(this.actionQueue.push(e),this.actionQueue.push(t)):(this.actionQueue.push(t),this.actionQueue.push(e))}executeNextAction(){if(this.actionQueue.length===0){this.endTurn();return}const e=this.actionQueue.shift(),t=e.creature,s=e.isPlayer?this.enemyCreature:this.playerCreature,i=t.useMove(e.moveIndex,s);this.showMessage(i.message,()=>{if(this.battleUI.updateHealthBars(),!s.isAlive()){this.endBattle(e.isPlayer);return}this.executeNextAction()})}endTurn(){this.battlePhase="CHOOSE_ACTION",this.battleUI.showActionMenu()}attemptRun(){this.enemyCreature.isWild?Math.random()<.5?this.showMessage("You successfully ran away!",()=>{h.emit("BATTLE_END",{result:"ESCAPED"})}):this.showMessage("Can't escape!",()=>{const t=this.chooseEnemyMove(),s=this.enemyCreature.useMove(t,this.playerCreature);this.showMessage(s.message,()=>{if(this.battleUI.updateHealthBars(),!this.playerCreature.isAlive()){this.endBattle(!1);return}this.battlePhase="CHOOSE_ACTION",this.battleUI.showActionMenu()})}):this.showMessage("Can't run from a trainer battle!",()=>{this.battlePhase="CHOOSE_ACTION",this.battleUI.showActionMenu()})}endBattle(e){this.battlePhase="END",this.battleUI.hideMenus();const t=e?`You defeated the wild ${this.enemyCreature.name}!`:`${this.playerCreature.name} was defeated!`;this.showMessage(t,()=>{h.emit("BATTLE_END",{result:e?"VICTORY":"DEFEAT",playerCreature:this.playerCreature,enemyCreature:this.enemyCreature})})}step(e,t){super.step(e,t),(this.battlePhase==="CHOOSE_ACTION"||this.battlePhase==="CHOOSE_MOVE")&&this.battleUI.handleInput(t.input)}}class C{constructor(e){this.name=e.name,this.power=e.power||0,this.accuracy=e.accuracy||100,this.type=e.type||"normal",this.category=e.category||"physical",this.pp=e.pp||10,this.maxPp=this.pp,this.description=e.description||"",this.effect=e.effect||null}canUse(){return this.pp>0}use(){return this.canUse()?(this.pp--,!0):!1}calculateDamage(e,t){if(this.power===0)return 0;const s=(this.category==="physical",e.stats.attack),i=(this.category==="physical",t.stats.defense),r=(2*e.stats.level+10)/250*(s/i)*this.power+2,n=Math.random()*.15+.85;return Math.floor(r*n)}hitCheck(){return Math.random()*100<this.accuracy}}const Se={tackle:new C({name:"Tackle",power:40,accuracy:100,type:"normal",category:"physical",pp:15,description:"A physical attack in which the user charges and slams into the target."}),scratch:new C({name:"Scratch",power:40,accuracy:100,type:"normal",category:"physical",pp:15,description:"Hard, pointed, sharp claws rake the target to inflict damage."}),heal:new C({name:"Heal",power:0,accuracy:100,type:"normal",category:"status",pp:5,description:"Restores HP.",effect:(a,e)=>{const t=Math.floor(a.stats.maxHp*.5);return a.stats.heal(t),{message:`${a.name} restored ${t} HP!`}}}),ember:new C({name:"Ember",power:60,accuracy:90,type:"fire",category:"special",pp:10,description:"The target is attacked with small flames."}),waterGun:new C({name:"Water Gun",power:55,accuracy:95,type:"water",category:"special",pp:12,description:"The target is blasted with a forceful shot of water."}),thunderShock:new C({name:"Thunder Shock",power:50,accuracy:95,type:"electric",category:"special",pp:12,description:"A jolt of electricity crashes down to inflict damage."})};function xe(a){const e=Se[a];if(!e)throw new Error(`Move ${a} not found in database`);return new C({name:e.name,power:e.power,accuracy:e.accuracy,type:e.type,category:e.category,pp:e.pp,description:e.description,effect:e.effect})}const Ae={fireStarter:{name:"Flameling",stats:{hp:80,attack:60,defense:45,speed:55,level:5},moves:["tackle","ember","heal"],sprite:null},waterStarter:{name:"Aqualing",stats:{hp:85,attack:50,defense:60,speed:45,level:5},moves:["tackle","waterGun","heal"],sprite:null},electricStarter:{name:"Sparkle",stats:{hp:75,attack:55,defense:40,speed:70,level:5},moves:["tackle","thunderShock","heal"],sprite:null},wildRat:{name:"Ratling",stats:{hp:50,attack:45,defense:35,speed:60,level:3},moves:["tackle","scratch"],sprite:null,isWild:!0},wildBird:{name:"Chirpling",stats:{hp:60,attack:50,defense:30,speed:80,level:4},moves:["tackle","scratch"],sprite:null,isWild:!0}};function R(a,e=null){const t=Ae[a];if(!t)throw new Error(`Creature template ${a} not found`);const s=t.moves.map(r=>xe(r)),i={...t.stats};if(e&&e!==i.level){const r=e-i.level,n=5;i.level=e,i.hp+=r*n,i.attack+=r*3,i.defense+=r*3,i.speed+=r*3}return new ve({name:t.name,stats:i,moves:s,sprite:t.sprite,isWild:t.isWild||!1})}class b{constructor(){this.creatures=[],this.activeCreature=0,this.addCreature(R("fireStarter",5))}addCreature(e){this.creatures.length<6&&this.creatures.push(e)}getActiveCreature(){return this.creatures[this.activeCreature]||null}hasAnyAliveCreatures(){return this.creatures.some(e=>e.isAlive())}switchActiveCreature(e){return e>=0&&e<this.creatures.length&&this.creatures[e].isAlive()?(this.activeCreature=e,!0):!1}healAllCreatures(){this.creatures.forEach(e=>{e.stats.hp=e.stats.maxHp,e.moves.forEach(t=>{t.pp=t.maxPp})})}}class Oe extends w{constructor(){super({}),this.level=null,this.input=new Q,this.camera=new ee,this.playerParty=new b,this.inBattle=!1}ready(){this.playerParty=new b,this.inBattle=!1;const e=new me;this.addChild(e),h.on("CHANGE_LEVEL",this,t=>{this.setLevel(t)}),h.on("WILD_ENCOUNTER",this,t=>{if(this.inBattle)return;const s=this.playerParty.getActiveCreature();if(!s){console.warn("No active creature to battle with!");return}this.startBattle(s,t.creature)}),h.on("TRAINER_BATTLE",this,t=>{if(this.inBattle)return;const s=this.playerParty.getActiveCreature();if(!s){console.warn("No active creature to battle with!");return}this.startBattle(s,t.creature)}),h.on("BATTLE_END",this,t=>{this.endBattle(t)}),h.on("HERO_REQUESTS_ACTION",this,t=>{if(t.isTrainer&&t.trainerCreature){h.emit("TRAINER_BATTLE",{trainer:t,creature:t.trainerCreature});return}if(typeof t.getContent=="function"){const s=t.getContent();if(!s)return;s.addsFlag&&G.add(s.addsFlag);const i=new W({portraitFrame:s.portraitFrame,string:s.string});this.addChild(i),h.emit("START_TEXT_BOX");const r=h.on("END_TEXT_BOX",this,()=>{i.destroy(),h.off(r)})}})}setLevel(e){this.level&&this.level.destroy(),this.level=e,this.addChild(this.level)}drawBackground(e){var t;(t=this.level)==null||t.background.drawImage(e,0,0)}drawObjects(e){this.inBattle?this.children.forEach(t=>{t.constructor.name==="BattleScene"&&t.draw(e,0,0)}):this.children.forEach(t=>{t.drawLayer!=="HUD"&&t.draw(e,0,0)})}drawForeground(e){this.children.forEach(t=>{t.drawLayer==="HUD"&&t.draw(e,0,0)})}startBattle(e,t){this.inBattle=!0,this.battleScene=new Ce(e,t),this.addChild(this.battleScene)}endBattle(e){switch(this.inBattle=!1,this.battleScene&&(this.battleScene.destroy(),this.battleScene=null),e.result){case"VICTORY":console.log("Battle won!");break;case"DEFEAT":console.log("Battle lost!"),this.playerParty.healAllCreatures();break;case"ESCAPED":console.log("Escaped from battle!");break}}}class K extends w{constructor(){super({}),this.background=null}}const u=a=>a*16,Me=(a,e,t)=>{const s=`${e},${t}`;return!a.has(s)};class $ extends w{constructor(e,t){super({position:new o(e,t)}),this.addChild(new y({resource:m.images.exit})),this.drawLayer="FLOOR"}ready(){h.on("HERO_POSITION",this,e=>{const t=Math.round(e.x),s=Math.round(e.y);t===this.position.x&&s===this.position.y&&h.emit("HERO_EXITS")})}}class ke{constructor(e){this.patterns=e,this.activeKey=Object.keys(this.patterns)[0]}get frame(){return this.patterns[this.activeKey].frame}play(e,t=0){this.activeKey!==e&&(this.activeKey=e,this.patterns[this.activeKey].currentTime=t)}step(e){this.patterns[this.activeKey].step(e)}}class T{constructor(e){this.currentTime=0,this.animationConfig=e,this.duration=e.duration??500}get frame(){const{frames:e}=this.animationConfig;for(let t=e.length-1;t>=0;t--)if(this.currentTime>=e[t].time)return e[t].frame;throw"Time is before the first keyframe"}step(e){this.currentTime+=e,this.currentTime>=this.duration&&(this.currentTime=0)}}const P=(a=0)=>({duration:400,frames:[{time:0,frame:a}]}),B=(a=0)=>({duration:400,frames:[{time:0,frame:a+1},{time:100,frame:a},{time:200,frame:a+1},{time:300,frame:a+2}]}),Le=P(1),Pe=P(4),Be=P(7),He=P(10),Re=B(0),De=B(3),_e=B(6),be=B(9),Ne={duration:400,frames:[{time:0,frame:12}]};function Fe(a,e,t){let s=e.x-a.position.x,i=e.y-a.position.y,r=Math.sqrt(s**2+i**2);if(r<=t)a.position.x=e.x,a.position.y=e.y;else{let n=s/r,l=i/r;a.position.x+=n*t,a.position.y+=l*t,s=e.x-a.position.x,i=e.y-a.position.y,r=Math.sqrt(s**2+i**2)}return r}class V extends w{constructor(e,t){super({position:new o(e,t)});const s=new y({resource:m.images.shadow,frameSize:new o(32,32),position:new o(-8,-19)});this.addChild(s),this.body=new y({resource:m.images.hero,frameSize:new o(32,32),hFrames:3,vFrames:8,frame:1,position:new o(-8,-20),animations:new ke({walkDown:new T(Re),walkUp:new T(_e),walkLeft:new T(be),walkRight:new T(De),standDown:new T(Le),standUp:new T(Be),standLeft:new T(He),standRight:new T(Pe),pickUpDown:new T(Ne)})}),this.addChild(this.body),this.facingDirection=S,this.destinationPosition=this.position.duplicate(),this.itemPickupTime=0,this.itemPickupShell=null,this.isLocked=!1,h.on("HERO_PICKS_UP_ITEM",this,i=>{this.onPickUpItem(i)})}ready(){h.on("START_TEXT_BOX",this,()=>{this.isLocked=!0}),h.on("END_TEXT_BOX",this,()=>{this.isLocked=!1})}step(e,t){if(this.isLocked)return;if(this.itemPickupTime>0){this.workOnItemPickup(e);return}const s=t.input;if(s!=null&&s.getActionJustPressed("Space")){const n=this.parent.children.find(l=>l.position.matches(this.position.toNeighbor(this.facingDirection)));n&&h.emit("HERO_REQUESTS_ACTION",n)}Fe(this,this.destinationPosition,1)<=1&&this.tryMove(t),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,h.emit("HERO_POSITION",this.position))}tryMove(e){var c;const{input:t}=e;if(!t.direction){this.facingDirection===x&&this.body.animations.play("standLeft"),this.facingDirection===A&&this.body.animations.play("standRight"),this.facingDirection===O&&this.body.animations.play("standUp"),this.facingDirection===S&&this.body.animations.play("standDown");return}let s=this.destinationPosition.x,i=this.destinationPosition.y;const r=16;t.direction===S&&(i+=r,this.body.animations.play("walkDown")),t.direction===O&&(i-=r,this.body.animations.play("walkUp")),t.direction===x&&(s-=r,this.body.animations.play("walkLeft")),t.direction===A&&(s+=r,this.body.animations.play("walkRight")),this.facingDirection=t.direction??this.facingDirection;const n=Me((c=e.level)==null?void 0:c.walls,s,i),l=this.parent.children.find(d=>d.isSolid&&d.position.x===s&&d.position.y===i);n&&!l&&(this.destinationPosition.x=s,this.destinationPosition.y=i)}onPickUpItem({image:e,position:t}){this.destinationPosition=t.duplicate(),this.itemPickupTime=500,this.itemPickupShell=new w({}),this.itemPickupShell.addChild(new y({resource:e,position:new o(0,-18)})),this.addChild(this.itemPickupShell)}workOnItemPickup(e){this.itemPickupTime-=e,this.body.animations.play("pickUpDown"),this.itemPickupTime<=0&&this.itemPickupShell.destroy()}}class X extends w{constructor(e,t){super({name:"Rod",position:new o(e,t)});const s=new y({resource:m.images.rod,position:new o(0,-5)});this.addChild(s)}ready(){h.on("HERO_POSITION",this,e=>{const t=Math.round(e.x),s=Math.round(e.y);t===this.position.x&&s===this.position.y&&this.onCollideWithHero()})}onCollideWithHero(){this.destroy(),h.emit("HERO_PICKS_UP_ITEM",{type:"ROD",image:m.images.rod,position:this.position})}}const Ue=new o(u(6),u(5));class We extends K{constructor(e={}){super({}),this.background=new y({resource:m.images.sky,frameSize:new o(320,180)});const t=new y({resource:m.images.ground,frameSize:new o(320,180)});this.addChild(t);const s=new $(u(6),u(3));this.addChild(s),this.heroStartPosition=e.heroPosition??Ue;const i=new V(this.heroStartPosition.x,this.heroStartPosition.y);this.addChild(i);const r=new X(u(7),u(6));this.addChild(r),this.walls=new Set,this.walls.add("64,48"),this.walls.add("64,64"),this.walls.add("64,80"),this.walls.add("80,64"),this.walls.add("80,80"),this.walls.add("112,80"),this.walls.add("128,80"),this.walls.add("144,80"),this.walls.add("160,80")}ready(){h.on("HERO_EXITS",this,()=>{h.emit("CHANGE_LEVEL",new z({heroPosition:new o(u(3),u(6))}))})}}class N extends w{constructor(e,t,s={}){super({position:new o(e,t)}),this.isSolid=!0,this.textContent=s.content,this.textPortraitFrame=s.portraitFrame;const i=new y({resource:m.images.shadow,frameSize:new o(32,32),position:new o(-8,-19)});this.addChild(i);const r=new y({resource:m.images.knight,frameSize:new o(32,32),hFrames:2,vFrames:1,position:new o(-8,-20)});this.addChild(r),this.isTrainer=s.isTrainer||!1,this.trainerCreature=s.trainerCreature||null}ready(){this.isTrainer&&h.on("HERO_REQUESTS_ACTION",this,()=>{this.trainerCreature&&h.emit("TRAINER_BATTLE",{trainer:this,creature:this.trainerCreature})})}getContent(){const e=G.getRelevantScenario(this.textContent);return e?{portraitFrame:this.textPortraitFrame,string:e.string,addsFlag:e.addsFlag??null}:(console.warn("No matches found in this list!",this.textContent),null)}}class F extends w{constructor(e,t,s={}){super({position:new o(e,t)}),this.encounterRate=s.encounterRate||.1,this.possibleEncounters=s.encounters||["wildRat","wildBird"],this.drawLayer="FLOOR",this.isInGrass=!1}ready(){h.on("HERO_POSITION",this,e=>{this.checkForEncounter(e)})}checkForEncounter(e){const t=Math.sqrt(Math.pow(e.x-this.position.x,2)+Math.pow(e.y-this.position.y,2)),s=this.isInGrass;this.isInGrass=t<16,this.isInGrass&&!s&&Math.random()<this.encounterRate&&this.triggerEncounter()}triggerEncounter(){const e=this.possibleEncounters[Math.floor(Math.random()*this.possibleEncounters.length)],t=R(e);h.emit("WILD_ENCOUNTER",{creature:t,location:this.position})}}const Ge=new o(u(6),u(5));class z extends K{constructor(e={}){super({}),this.background=new y({resource:m.images.cave,frameSize:new o(320,360)});const t=new y({resource:m.images.caveGround,frameSize:new o(320,180)});this.addChild(t);const s=new $(u(3),u(5));this.addChild(s),this.heroStartPosition=e.heroPosition??Ge;const i=new V(this.heroStartPosition.x,this.heroStartPosition.y);this.addChild(i);const r=new X(u(9),u(6));this.addChild(r);const n=new F(u(4),u(6),{encounterRate:.2,encounters:["wildRat"]});this.addChild(n);const l=new F(u(7),u(4),{encounterRate:.15,encounters:["wildRat","wildBird"]});this.addChild(l);const c=new N(u(5),u(5),{content:[{string:"I challenge you to a battle!",requires:[],addsFlag:_},{string:"Good battle! You're getting stronger.",requires:[_]}],portraitFrame:1,isTrainer:!0,trainerCreature:R("electricStarter",6)});this.addChild(c);const d=new N(u(8),u(5),{content:[{string:"Be careful in the wild areas! Strange creatures roam there.",requires:[],addsFlag:Ee}],portraitFrame:0});this.addChild(d),this.walls=new Set}ready(){h.on("HERO_EXITS",this,()=>{h.emit("CHANGE_LEVEL",new We({heroPosition:new o(u(16),u(4))}))}),h.on("TRAINER_BATTLE",this,e=>{console.log("Trainer battle triggered!",e)})}}const H=document.querySelector("#game-canvas"),I=H.getContext("2d"),E=new Oe({position:new o(0,0)});E.setLevel(new z);const Ke=a=>{var e;E.stepEntry(a,E),(e=E.input)==null||e.update()},$e=()=>{I.clearRect(0,0,H.width,H.height),E.drawBackground(I),I.save(),E.camera&&I.translate(E.camera.position.x,E.camera.position.y),E.drawObjects(I),I.restore(),E.drawForeground(I)},Ve=new j(Ke,$e);Ve.start();
